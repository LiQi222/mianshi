<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç®€å†é¢è¯•é—®é¢˜ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 20px auto; background-color: #fff; padding: 20px 40px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        header, .auth-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; border-left: 4px solid #3498db; padding-left: 15px; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; }
        button { display: block; width: 100%; padding: 15px; background: #3498db; color: #fff; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .nav { text-align: center; margin-bottom: 20px; }
        .nav-btn, .auth-link { background: none; border: none; color: #3498db; cursor: pointer; font-size: 16px; margin: 0 10px; padding: 5px; }
        .nav-btn:hover, .auth-link:hover { text-decoration: underline; }
        #user-info { float: right; margin-top: -50px; }
        #history-list { list-style-type: none; padding: 0; }
        #history-list li { background: #f8f9fa; margin-bottom: 15px; padding: 15px; border-radius: 8px; border-left: 3px solid #1abc9c; }
        #history-list .timestamp { font-size: 0.8em; color: #7f8c8d; display: block; margin-bottom: 10px; }
        #error-message { color: red; text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">

        <!-- ç™»å½•è§†å›¾ -->
        <div id="login-view">
            <div class="auth-header"><h1>æ¬¢è¿å›æ¥</h1></div>
            <div id="login-error" class="error-message"></div>
            <form id="login-form">
                <input type="text" id="login-username" placeholder="ç”¨æˆ·å" required>
                <input type="password" id="login-password" placeholder="å¯†ç " required>
                <button type="submit">ç™»å½•</button>
            </form>
            <p style="text-align:center; margin-top: 20px;">
                è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ <a href="#" id="show-register-link" class="auth-link">ç«‹å³æ³¨å†Œ</a>
            </p>
        </div>

        <!-- æ³¨å†Œè§†å›¾ -->
        <div id="register-view" class="hidden">
            <div class="auth-header"><h1>åˆ›å»ºæ–°è´¦æˆ·</h1></div>
            <div id="register-error" class="error-message"></div>
            <form id="register-form">
                <input type="text" id="register-username" placeholder="ç”¨æˆ·å" required>
                <input type="password" id="register-password" placeholder="å¯†ç " required>
                <button type="submit">æ³¨å†Œ</button>
            </form>
            <p style="text-align:center; margin-top: 20px;">
                å·²æœ‰è´¦æˆ·ï¼Ÿ <a href="#" id="show-login-link" class="auth-link">è¿”å›ç™»å½•</a>
            </p>
        </div>

        <!-- ä¸»åº”ç”¨è§†å›¾ -->
        <div id="app-view" class="hidden">
            <div id="user-info">
                æ¬¢è¿, <span id="username-display"></span>! 
                <button id="logout-btn" class="nav-btn">é€€å‡ºç™»å½•</button>
            </div>
            <header>
                <h1>ğŸ¤– AI ç®€å†åˆ†æ</h1>
                <div class="nav">
                    <button id="show-analyzer-btn" class="nav-btn">å¼€å§‹åˆ†æ</button>
                    <button id="show-history-btn" class="nav-btn">å†å²è®°å½•</button>
                </div>
            </header>

            <!-- åˆ†æå™¨ç•Œé¢ -->
            <div id="analyzer-section">
                <form id="resume-form">
                    <div class="form-group">
                        <label for="resume-file">1. ä¸Šä¼ æ‚¨çš„ç®€å† (PDF)</label>
                        <input type="file" id="resume-file" name="resume" accept=".pdf" required>
                    </div>
                    <div class="form-group">
                        <label for="job-description">2. (å¯é€‰) ç²˜è´´ç›®æ ‡å²—ä½æè¿°</label>
                        <textarea id="job-description" name="jd" rows="8" placeholder="ç²˜è´´èŒä½æè¿°..."></textarea>
                    </div>
                    <button type="submit" id="submit-btn">âœ¨ ç”Ÿæˆé¢è¯•é—®é¢˜</button>
                </form>
                <div id="loading" class="hidden" style="text-align:center; padding: 40px 0;">AIåˆ†æä¸­...</div>
                <div id="results-container" class="hidden">
                    <h2>ğŸ’¡ AI ç”Ÿæˆçš„é¢è¯•é—®é¢˜</h2>
                    <div id="results"></div>
                </div>
            </div>

            <!-- å†å²è®°å½•ç•Œé¢ -->
            <div id="history-section" class="hidden">
                <h2>ğŸ“œ æ‚¨çš„å†å²è®°å½•</h2>
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // å…¨å±€DOMå…ƒç´ 
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const appView = document.getElementById('app-view');
        const analyzerSection = document.getElementById('analyzer-section');
        const historySection = document.getElementById('history-section');

        // åˆ‡æ¢è§†å›¾çš„å‡½æ•°
        const showView = (viewToShow) => {
            [loginView, registerView, appView].forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        };
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const showError = (elementId, message) => {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message || '';
        };

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        const checkAuth = async () => {
            const response = await fetch('/api/check_auth');
            const data = await response.json();
            if (data.is_authenticated) {
                document.getElementById('username-display').textContent = data.username;
                showView(appView);
            } else {
                showView(loginView);
            }
        };

        // --- äº‹ä»¶ç›‘å¬ ---

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', checkAuth);

        // åˆ‡æ¢åˆ°æ³¨å†Œè§†å›¾
        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            showView(registerView);
        });

        // åˆ‡æ¢åˆ°ç™»å½•è§†å›¾
        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showView(loginView);
        });
        
        // æ³¨å†Œè¡¨å•æäº¤
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (response.ok) {
                alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚');
                showView(loginView);
                showError('register-error', '');
            } else {
                showError('register-error', data.error);
            }
        });

        // ç™»å½•è¡¨å•æäº¤
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('username-display').textContent = data.username;
                showView(appView);
                showError('login-error', '');
            } else {
                showError('login-error', data.error);
            }
        });

        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            showView(loginView);
        });

        // æ˜¾ç¤ºåˆ†æå™¨ç•Œé¢
        document.getElementById('show-analyzer-btn').addEventListener('click', () => {
            analyzerSection.classList.remove('hidden');
            historySection.classList.add('hidden');
        });

        // æ˜¾ç¤ºå†å²è®°å½•ç•Œé¢
        document.getElementById('show-history-btn').addEventListener('click', async () => {
            analyzerSection.classList.add('hidden');
            historySection.classList.remove('hidden');
            const response = await fetch('/api/history');
            const data = await response.json();
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (data.length === 0) {
                historyList.innerHTML = '<li>æ²¡æœ‰å†å²è®°å½•ã€‚</li>';
            } else {
                data.forEach(item => {
                    const li = document.createElement('li');
                    const timestamp = new Date(item.timestamp).toLocaleString();
                    li.innerHTML = `<span class="timestamp">${timestamp}</span><div>${marked.parse(item.questions)}</div>`;
                    historyList.appendChild(li);
                });
            }
        });

        // åˆ†æè¡¨å•æäº¤
        document.getElementById('resume-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('loading');
            const resultsContainer = document.getElementById('results-container');
            const resultsDiv = document.getElementById('results');
            
            loading.classList.remove('hidden');
            resultsContainer.classList.add('hidden');

            const formData = new FormData(e.target);
            const response = await fetch('/api/analyze', { method: 'POST', body: formData });
            const data = await response.json();
            
            loading.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

            if (data.error) {
                resultsDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
            } else {
                resultsDiv.innerHTML = marked.parse(data.questions);
            }
        });
    </script>
</body>
</html>
